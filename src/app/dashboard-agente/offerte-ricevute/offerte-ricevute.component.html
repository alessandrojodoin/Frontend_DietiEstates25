<div class="search-offerts">
  <button
    role="tab"
    type="button"
    (click)="offerteInAttesa()"
    class="tab Attesa"
    [attr.aria-selected]="selected === 'attesa'"
    [class.selected]="selected === 'attesa'">
    Offerte In Attesa
  </button>

  <button
    role="tab"
    type="button"
    (click)="offerteAccettate()"
    class="tab Accettate"
    [attr.aria-selected]="selected === 'accettate'"
    [class.selected]="selected === 'accettate'">
    Offerte Accettate
  </button>
</div>

@if (loading) {
  <div class="loader-container">
    <div class="spinner"></div>
    <p>Caricamento offerte in corso...</p>
  </div>

  
} @else {
  @if(ImmobiliList.length === 0){
    <div class="empty-state">
      <p>Qui verranno mostrate le offerte ricevute</p>
    </div>
  }@else{
@for(immobile of ImmobiliList; track immobile) {

    @if((this.selected === 'attesa' && statoImmobile(immobile) === 'attesa' && !immobile.isVenduto) || (this.selected === 'accettate' && statoImmobile(immobile) === 'accettata' && !immobile.isVenduto)){
        
             @if (mostraPopupOfferte) {
  <div class="overlay">
    <div class="popup">

        <h3>Aggiungi Offerta</h3>

        <form [formGroup]="offertaForm" (ngSubmit)="onSubmit(immobile.id)">

          <label for="nomeOfferente">Nome Offerente*:</label>
          <input id="nomeOfferente" type="text" formControlName="nome" />

          <label for="cognomeOfferente">Cognome Offerente*:</label>
          <input id="cognomeOfferente" type="text" formControlName="cognome" />

          <label for="emailOfferente">Email Offerente*:</label>
          <input id="emailOfferente" type="email" formControlName="email" />

          <label for="numeroTelefonico">Recapito Telefonico*:</label>
          <input id="numeroTelefonico" type="text" formControlName="numeroTelefonico" />

          <label for="valoreOfferta">Valore Offerta*:</label>
          <input id="valoreOfferta" formControlName="valoreOfferta" placeholder="Importo (â‚¬)" />

          <div class="popup-actions">
            <button type="button"
                    class="btn-secondary"
                    (click)="chiudiPopupOfferta()">
              Indietro
            </button>

            <button type="submit"
                    class="btn-primary"
                    [disabled]="offertaForm.invalid">
              + Aggiungi
            </button>
          </div>

        </form>


    </div>
  </div>
}
<div class="immobile-card">
          <div class="immobile-header">
            <h2 class="indirizzo-immobile">
              <a [routerLink]="['/dettagli-immobile', immobile.id]">{{ immobile.indirizzo.via }}, {{ immobile.indirizzo.citta }} ({{ immobile.indirizzo.provincia }})</a>
            </h2>

            <button class="aggiungi-offerta" (click)="apriPopupOfferta(); $event.stopPropagation()">+ Aggiungi Offerta</button>
          </div>
     

      <div class="offerte-container">
        @for(offerta of immobile.offerte; track offerta) {
          <div class="offerta-card" [class.offerta-disabilitata]="
    selected === 'accettate' && offerta.statoOfferta !== 'Accettata'">
            <div class="offerta-inner">
              <div class="offerta-info">
                <p><strong>Nome:</strong> {{offerta.nomeOfferente}}</p>
                <p><strong>Cognome:</strong> {{offerta.cognomeOfferente}}</p>
                <p><strong>Telefono:</strong> {{offerta.telefono}}</p>
                <p><strong>Email:</strong> {{offerta.emailOfferente}}</p>
              </div>

              <div class="offerta-body">
                <div class="offerta-box">
                  Offerta: â‚¬{{ offerta.cifraOfferta | number:'1.0-0' }}
                </div>
              </div>
            </div>

            <div class="data">
              ðŸ“… {{ offerta.dataOfferta | date:'dd/MM/yyyy HH:mm' }}
            </div>

          <div class="azioni">

           <!-- STATO: IN ATTESA -->
          @if (selected === 'attesa') {
    
            <button class="btn-accetta" (click)="accetta(offerta.offertaId); $event.stopPropagation()">Accetta</button>
            <button class="btn-rifiuta" (click)="apriPopupRifiuto(offerta.offertaId); $event.stopPropagation()">Rifiuta</button>
          }

          <!-- STATO: ACCETTATA (solo quella vincente) -->
          @if (selected === 'accettate' && offerta.statoOfferta === 'Accettata') {

            <button class="btn-primary" (click)="concludiContratto(immobile.id)">Concludi contratto</button>
            <button class="btn-secondary" (click)="annullaAccettazione(offerta.offertaId)">Annulla accettazione</button>
          }

        </div>

          </div>
        }
      </div>
    </div>
    }
    
  }

  
  @if (mostraPopup) {
    <div class="overlay">
      <div class="popup">
        @if (statoPopup === 'chiedi') {
          <h3>Vuoi fare una controproposta?</h3>
          <div class="popup-actions">
            <button class="btn-secondary" (click)="confermaRifiuto()">No</button>
            <button class="btn-primary" (click)="vaiAControproposta()">SÃ¬</button>
          </div>
        }

        @if (statoPopup === 'controproposta') {
          <h3>Inserisci la controproposta</h3>
          <input type="number" placeholder="Importo (â‚¬)" [(ngModel)]="controproposta" />
          <div class="popup-actions">
            <button class="btn-secondary" (click)="tornaAllaDomanda()">Indietro</button>
            <button class="btn-primary" [disabled]="controproposta <= 0" (click)="inviaControproposta()">Invia</button>
          </div>
        }

        @if (statoPopup === 'successo') {
          <h3>âœ… Controproposta inviata</h3>
          <p>La controproposta Ã¨ stata inviata con successo.</p>
          <div class="popup-actions">
            <button class="btn-primary" (click)="chiudiPopup()">OK</button>
          </div>
        }
      </div>
    </div>
  }

}

  
}
  